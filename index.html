<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RabbitMQ Web AMQP 1.0 Connection</title>
    <script src="rhea.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #log { background: #f0f0f0; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 10px; }
       .error { color: red; }
       .success { color: green; }
    </style>
</head>
<body>
    <h2>RabbitMQ Web AMQP 1.0 Test</h2>
    <div>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
    </div>
    <hr>
    <div>
        <input type="text" id="msgInput" placeholder="Type a message..." disabled>
        <button id="sendBtn" onclick="sendMessage()" disabled>Send Message</button>
    </div>
    
    <h3>Connection Log</h3>
    <div id="log"></div>

    <script>
        // GLOBAL CONFIGURATION
        // 1. Port 15678 is the standard Web AMQP port.
        // 2. The path /ws is defined by the RabbitMQ plugin.
        const BROKER_URL = 'ws://localhost:15678/ws';
        
        // YOUR CREDENTIALS
        const USERNAME = 'arul';
        const PASSWORD = 'password';

        // Rhea AMQP 1.0 Connection Reference
        let connection = null;
        let sender = null;
        let receiver = null;

        function connect() {
            log('Attempting connection to ' + BROKER_URL + '...');

            connection = rhea.connect({
                connection_details: rhea.websocket_connect(WebSocket)(BROKER_URL, ["binary", "AMQPWSB10", "amqp"]),
                username: USERNAME,
                password: PASSWORD
            });

            connection.on('connection_open', function(context) {
                setConnected(true);
                log('CONNECTED successfully!', 'success');

                sender = context.connection.open_sender('q.test');
                receiver = context.connection.open_receiver('q.test');
                
                receiver.on('message', function(context) {
                    log('RECEIVED: ' + context.message.body.toString());
                });

                log('Opened sender and receiver for q.test');
            });

            connection.on('disconnected', function(context) {
                setConnected(false);
                log('Disconnected', 'error');
            });

            connection.on('connection_error', function(context) {
                log('Connection error: ' + context.error, 'error');
            });

            connection.on('sender_open', function(context) {
                log('Sender opened for ' + context.sender.target.address);
            });

            connection.on('receiver_open', function(context) {
                log('Receiver opened for ' + context.receiver.source.address);
            });
        }

        function disconnect() {
            if (connection) {
                connection.close();
                setConnected(false);
                log('Disconnected');
            }
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const message = input.value;
            
            if (sender && connection.is_open()) {
                sender.send({ body: message });
                log('SENT: ' + message);
                input.value = '';
            } else {
                log('Not connected or sender not ready.', 'error');
            }
        }

        // UI Helper Functions
        function setConnected(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled =!connected;
            document.getElementById('sendBtn').disabled =!connected;
            document.getElementById('msgInput').disabled =!connected;
        }

        function log(message, type) {
            const logDiv = document.getElementById('log');
            const p = document.createElement('p');
            p.style.margin = '5px 0';
            if (type === 'error') p.style.color = 'red';
            if (type === 'success') p.style.color = 'green';
            p.textContent = ` ${message}`;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>